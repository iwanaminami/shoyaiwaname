---
layout: post
title:  "プラグインなしで同じタグを持つ全ての投稿を取得する【Jekyll】"
description: 記事のタグでforループを回して、同じタグを持つ記事を全て取得して、重複を削除し、リンクを作成します。
date:   2020-02-20 09:00:00 +0900
last_modified_at: 2020-02-20 09:00:00 +0900
tags:
- Jekyll
- GithubPages
- Liqiud
categories:
image: /assets/images/iwananotebook.png
---

{{ page.description }}

---

## Jekyll + Github Pagesではプラグインが利用できない

関連記事を返してくれるプラグインがあるようですが、Github Pages上でJekyllをビルドしているサイトではプラグインを利用できません。

{% include cardblank.html url="https://github.com/alfanick/jekyll-related-posts" %}

また、`site.related_posts`という変数は最新記事を返すようです。

{% include cardblank.html url="https://blog.shimar.me/2016/11/15/jekyll-site-related-posts.html" %}



```liquid
{% raw %}
{{ hello }}
{% endraw %}
```

※うまくいったというだけで、正しいとは限りません！

## GASとJavascriptでリンクカードを作ろうと思った理由

Jekyll + Github Pagesで公開するウェブサイトの作成では、liquidによってサイトや各ページの情報を取得することができ、forループなどの制御もできるので、構造的なサイト構築を行うことができます。

### リンクカードとは

ブログ記事の途中で他のサイトや自分の他の記事のリンクを貼る際に、よりクリックしてもらえるように、**画像+タイトル** のようにその記事の内容がわかりやすいカードを貼ることがあります。

SNSではFacebookやTwitterでウェブサイトのリンクをシェアすると、メタタグが読み取られ、大きい画像とタイトル、説明文が表示されることがあります。他にも有名なのははてなブログで、はてなブログのリンクカードにはシェアの数などの情報も含まれます。はてなブログでは独自のAPIを使ってこのリンクカードを生成しているようです。

### Github Pagesではサーバーサイドでの実行ができない

他のサイトの情報を参照するサービスの多くは、サーバーサイドで何かしらのプログラムを実行して情報を取得しています。

しかし、Github PagesではPHPなどのサーバーサイドで実行されるプログラムを使うことができません。何かしらのアクションを実行しようとするとJavascriptを主に使うことになります。

なので、Jekyll + Github Pagesで公開しているウェブサイトに外部サイトのリンクカードを載せようと思う場合、手動で情報を取ってきて毎回入力するか、外部のサービスを使うことになります。

### 実装方法の検討

**手動**  
毎回リンクを載せたいウェブサイトを見て情報を取ってきて全ての必要な情報をて入力することは考えられません。

**外部のサービス**  
外部のサービスには、ウェブサイトの情報を返してくれるだけのものや、リンクカードを作成してくれるサービスに接続するためのコードを生成してくれるものなどあります。情報を返すサービスは、帰ってきた情報をコピペする手間がかかりますし、リンクカードを作成してくれるサービスはそのサービスのロゴが入ったり、デザインの自由度が低かったりします。

**Google Apps Script**  
ここで利用できるのがGoogle Apps Script（GAS）というクラウドサービスです。GASは主にGoogleが提供するG Suiteのサービス（Googleドキュメント、Googleスプレッドシート、Googleカレンダー、、などなど）を連携させたり、処理を自動化したりするサービスです。

{% include cardblank.html url = "https://script.google.com" %}

GASにはウェブサイトのURLからそのサイトの情報を取得してくれる関数が準備されています。これは、GASはクラウド（サーバー）上で動くので、他のウェブサイトの情報を抜き取ることが可能であるということです。かつ、GASで作成したプログラムはAPIとして公開することができるので、Javascriptから呼び出すことができます。

## 実装

### コンセプト

Github Pages上で公開しているJekyllサイトでのリンクカード自動作成を以下の流れで実装することにしました。

1. markdownファイルのなかで、liquidのincludeを利用してリンクカード作成用のhtmlファイルを読み込む。その際にウェブサイトのURLを渡す。
2. 1.で呼び出したhtmlファイルでJavascriptを実行し、GASのAPIにURLを渡す。
3. GASでURLを受け取り、そのサイトの情報（タイトル、説明、ファビコン、ホストドメイン）を返す。
4. GASから帰ってきたレスポンスを受け取り、Javascriptでリンクカードをレンダリングする。

2-4のクライアントとGASのAPIとの通信にはjQueryのAjaxを使いました。

### markdownファイルのなかで、liquidのincludeを利用してリンクカード作成用のhtmlファイルを読み込む。その際にウェブサイトのURLを渡す

Jekyllではmarkdownを用いて記事（post）を書きます。また、liquidという言語でループやif文などを利用できます。

includeを使うと別に```_include```のディレクトリに用意しておいたhtmlファイルをドキュメントの途中に挿入することができます。さらに挿入するhtmlファイルに変数を渡すこともできます。

```

```

とすることで、https://example.com というURLを渡しながらexample.htmlというファイルを挿入することができます。

渡した```url```はexample.htmlの中で``` ```として利用できます。

### Javascriptを実行し、GASのAPIにURLを渡す



### GASでURLを受け取り、そのサイトの情報（タイトル、説明、ファビコン、ホストドメイン）を返す




### GASから帰ってきたレスポンスを受け取り、Javascriptでリンクカードをレンダリングする



a
